<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.547">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<meta name="description" content="学习如何创建软件包（package），它是可分享、可复用和可重复的 R 代码。">
<title>R Packages (2e) - 3&nbsp; 软件包结构与状态</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./workflow101.html" rel="next">
<link href="./setup.html" rel="prev">
<link href="./images/cover-2e-small.png" rel="icon" type="image/png">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><script defer="" data-domain="r-pkgs.org" src="https://plausible.io/js/plausible.js"></script>
</head>
<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./whole-game.html">入门</a></li><li class="breadcrumb-item"><a href="./structure.html"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">软件包结构与状态</span></a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">R Packages (2e)</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/YuanchenZhu2020/R-Packages-zh" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
  <a href="" class="quarto-reader-toggle quarto-navigation-tool px-1" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">欢迎！</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./translator-preface.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">翻译与排版说明</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./preface.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">前言</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./introduction.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">简介</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">入门</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./whole-game.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">整个流程</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./setup.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">系统设置</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./structure.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">软件包结构与状态</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./workflow101.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">基本开发工作流</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./package-within.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">The package within</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">References</span></span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
 <span class="menu-text">Appendices</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./R-CMD-check.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title"><code>R CMD check</code></span></span></a>
  </div>
</li>
      </ul>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li><a href="#sec-package-states" id="toc-sec-package-states" class="nav-link active" data-scroll-target="#sec-package-states"><span class="header-section-number">3.1</span> 软件包状态</a></li>
  <li><a href="#sec-source-package" id="toc-sec-source-package" class="nav-link" data-scroll-target="#sec-source-package"><span class="header-section-number">3.2</span> 源码包 (Source Package)</a></li>
  <li>
<a href="#sec-bundled-package" id="toc-sec-bundled-package" class="nav-link" data-scroll-target="#sec-bundled-package"><span class="header-section-number">3.3</span> 归档包 (Bundled Package)</a>
  <ul class="collapse">
<li><a href="#sec-rbuildignore" id="toc-sec-rbuildignore" class="nav-link" data-scroll-target="#sec-rbuildignore"><span class="header-section-number">3.3.1</span> <code>.Rbuildignore</code></a></li>
  </ul>
</li>
  <li><a href="#sec-structure-binary" id="toc-sec-structure-binary" class="nav-link" data-scroll-target="#sec-structure-binary"><span class="header-section-number">3.4</span> 二进制包 (Binary Package)</a></li>
  <li><a href="#sec-installed-package" id="toc-sec-installed-package" class="nav-link" data-scroll-target="#sec-installed-package"><span class="header-section-number">3.5</span> 已安装的包 (Installed package)</a></li>
  <li><a href="#%E5%86%85%E5%AD%98%E4%B8%AD%E7%9A%84%E5%8C%85-in-memory-package" id="toc-内存中的包-in-memory-package" class="nav-link" data-scroll-target="#%E5%86%85%E5%AD%98%E4%B8%AD%E7%9A%84%E5%8C%85-in-memory-package"><span class="header-section-number">3.6</span> 内存中的包 (In-memory package)</a></li>
  <li><a href="#sec-library" id="toc-sec-library" class="nav-link" data-scroll-target="#sec-library"><span class="header-section-number">3.7</span> 软件包库 (Package libraries)</a></li>
  </ul><div class="toc-actions"><ul><li><a href="https://github.com/YuanchenZhu2020/R-Packages-zh/edit/main/structure.Rmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/YuanchenZhu2020/R-Packages-zh/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./whole-game.html">入门</a></li><li class="breadcrumb-item"><a href="./structure.html"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">软件包结构与状态</span></a></li></ol></nav><div class="quarto-title">
<h1 class="title"><span id="sec-package-structure-state" class="quarto-section-identifier"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">软件包结构与状态</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header><p>本章将会把你从<em>使用</em> R 包中获得的隐式知识转化为<em>创建和修改</em> R 包所需的显式知识，从而使你踏上 R 软件包开发之路。 你将会了解到软件包可能处于的各种状态，以及包 (package) 和库 (library) 之间的区别（以及为什么你应该关心这些区别）。</p>
<section id="sec-package-states" class="level2" data-number="3.1"><h2 data-number="3.1" class="anchored" data-anchor-id="sec-package-states">
<span class="header-section-number">3.1</span> 软件包状态</h2>
<p>当你创建或修改软件包时，需要在它的“源代码”或“源文件”上进行。 你会以<strong>源代码</strong>的形式和正在开发中的包进行交互。 当然，这并不是你在日常使用中最熟悉的软件包形式。 但是，如果你了解 R 包可能处于的五种状态，那么软件包开发工作流将变得更有意义：</p>
<ul>
<li>源代码状态 (source)</li>
<li>打包状态 (bundled)</li>
<li>二进制文件状态 (binary)</li>
<li>已安装状态 (installed)</li>
<li>载入内存状态 (in-memory)</li>
</ul>
<p>你可能已经了解一些将软件包置于这些状态的函数。 例如，<code><a href="https://rdrr.io/r/utils/install.packages.html">install.packages()</a></code> 函数可以将软件包从源代码状态、打包状态或二进制文件状态转为已安装状态。 <code><a href="https://remotes.r-lib.org/reference/install_github.html">devtools::install_github()</a></code> 函数获取 GitHub 上的源代码软件包并将其转为已安装状态。 而 <code><a href="https://rdrr.io/r/base/library.html">library()</a></code> 函数将已安装的软件包加载到内存中，使其立即可以直接使用。</p>
</section><section id="sec-source-package" class="level2" data-number="3.2"><h2 data-number="3.2" class="anchored" data-anchor-id="sec-source-package">
<span class="header-section-number">3.2</span> 源码包 (Source Package)</h2>
<p>一个<strong>源代码</strong>软件包就是一个有着特定结构的文件目录。 它包含特定的组件，例如一个 <code>DESCRIPTION</code> 文件，包含 <code>.R</code> 文件的 <code>R/</code> 目录等等。 本书其余的大部分章节都致力于详细介绍这些组件。</p>
<p>如果你刚刚接触 R 包开发，那么你可能从未见过源代码形式的软件包！ 你的计算机上甚至可能没有任何源码包。 以源代码形式查看软件包的最简单的方法是在网站上浏览其代码。</p>
<p>许多 R 包是在 GitHub（或者 GitLab 以及类似的平台）上公开开发的。 要找到它们的网址，最好的情况是你能够访问软件包的 CRAN 主页 (landing page)，例如：</p>
<ul>
<li>forcats: <a href="https://cran.r-project.org/package=forcats" class="uri">https://cran.r-project.org/package=forcats</a>
</li>
<li>readxl: <a href="https://cran.r-project.org/package=readxl" class="uri">https://cran.r-project.org/package=readxl</a>
</li>
</ul>
<p>页面中一个 URL 会链接到公共托管服务上的存储库，例如：</p>
<ul>
<li>forcats: <a href="https://github.com/tidyverse/forcats" class="uri">https://github.com/tidyverse/forcats</a>
</li>
<li>readxl: <a href="https://github.com/tidyverse/readxl" class="uri">https://github.com/tidyverse/readxl</a>
</li>
</ul>
<p>即使这个包是在公共存储库中开发的，有时候一些维护者会忘记列出这个 URL，但是你仍然可以通过搜索发现它。</p>
<p>即使软件包不是在公共平台上开发的，你也可以通过 <a href="https://docs.r-hub.io/#cranatgh">由 R-hub 维护的非官方只读镜像</a> 来访问其源代码，例如：</p>
<ul>
<li>MASS: <a href="https://github.com/cran/MASS" class="uri">https://github.com/cran/MASS</a>
</li>
<li>car: <a href="https://github.com/cran/car" class="uri">https://github.com/cran/car</a>
</li>
</ul>
<p>请注意，在 <code>cran</code> GitHub 组织中探索软件包的源代码及其开发历史并不等同于探索软件包真正的开发场所，因为里面的源代码和演变历史只是根据它在 CRAN 的正式发布版本 (release) 中通过逆向工程提取出来的。 我们看到的这只是对软件包及其开发历史的一种编辑结果，但根据定义，它仍然包含了所有必需的内容。</p>
</section><section id="sec-bundled-package" class="level2" data-number="3.3"><h2 data-number="3.3" class="anchored" data-anchor-id="sec-bundled-package">
<span class="header-section-number">3.3</span> 归档包 (Bundled Package)<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>
</h2>
<p>一个<strong>归档打包的</strong>软件包是被压缩成单个文件的软件包。 按照惯例（该惯例来自 Linux），R 中的归档包使用 <code>.tar.gz</code> 扩展名，有时候也被称为 “source tarballs”。 这意味着多个文件已经被打包为一个文件 (<code>.tar</code>) 并使用 gzip (<code>.gz</code>) 进行压缩。 虽然归档包本身并不那么有用，但它是源码包和已安装包之间平台无关、便于传输的中间媒介。</p>
<p>在从本地开发的软件包中生成归档包这种罕见的情况下，请使用 <code><a href="https://devtools.r-lib.org/reference/build.html">devtools::build()</a></code> 函数。 在幕后，它会调用 <code><a href="https://pkgbuild.r-lib.org/reference/build.html">pkgbuild::build()</a></code> 并最终调用 <code>R CMD build</code>，这些内容会在 <a href="https://cran.r-project.org/doc/manuals/R-exts.html">Writing R Extensions</a> 的 <a href="https://cran.r-project.org/doc/manuals/R-exts.html#Building-package-tarballs">Building package tarballs</a> 章节中进行更多阐述。</p>
<p>这应该会提醒你，归档包或 “source tarball” 不仅仅是对源文件进行 tar 打包归档，然后使用 gzip 压缩的结果。 按照惯例，在 R 世界中，在制作 <code>.tar.gz</code> 文件时还要执行一些操作，而这就是为什么我们选择在本书中将这种形式称为<strong>归档包</strong>的原因。</p>
<p>每一个 CRAN 软件包都以归档包的形式提供，可以通过软件包主页 (landing page) 中 “Package source” 字段获取。 继续我们上面的示例，你可以下载归档包 <code>forcats_0.4.0.tar.gz</code> 和 <code>readxl_1.3.1.tar.gz</code>（或者任何当前的版本）。 你可以在 shell（而不是 R 控制台）中进行解压：</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tar</span> xvf forcats_0.4.0.tar.gz</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>如果解压一个归档包，你会发现它看起来几乎与源码包相同。 <a href="#fig-package-files" class="quarto-xref">Figure&nbsp;<span>3.1</span></a> 展示了一个名为 zzzpackage 的虚构软件包的源码包、归档包和二进制包中的文件。 我们精心设计了这个示例，以包含本书中涉及的大部分软件包组件。 不过，不是每个软件包都包含这里看到的每个文件，这个图也不包括包中可能出现的每个文件。</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-package-files" class="quarto-figure quarto-figure-center quarto-float anchored" alt="源码包、归档包和二进制包之间并列比较。 展示了从软件包源代码到打包状态，再到二进制状态的流向（包括路径和格式） 这一过程将在本章适当命名的章节中 进行详细介绍。">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-package-files-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="diagrams/package-files.png" class="img-fluid figure-img" alt="源码包、归档包和二进制包之间并列比较。 展示了从软件包源代码到打包状态，再到二进制状态的流向（包括路径和格式） 这一过程将在本章适当命名的章节中 进行详细介绍。" width="1360">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-package-files-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.1: 软件包形式：源代码 vs.&nbsp;归档 vs.&nbsp;二进制。
</figcaption></figure>
</div>
</div>
</div>
<p>未压缩的归档包相比于源码包的主要区别为：</p>
<ul>
<li><p>已经构建了主题文档 (vignettes)，因此渲染好的输出文件，例如 HTML 会出现在 <code>inst/doc/</code> 目录下，并且主题文档 (vignette) 索引会出现在 <code>build/</code> 目录中。</p></li>
<li><p>本地源码包可能包含用于在开发期间节省时间的临时文件，例如 <code>src/</code> 中的编译产物 (compilation artifacts)。 这些文件不会在归档包中出现。</p></li>
<li><p><code>.Rbuildignore</code> 中列出的任何文件都不包含在捆绑包中。 这些文件通常有助于你的开发过程，但应该从分发的最终产品中排除。</p></li>
</ul>
<section id="sec-rbuildignore" class="level3" data-number="3.3.1"><h3 data-number="3.3.1" class="anchored" data-anchor-id="sec-rbuildignore">
<span class="header-section-number">3.3.1</span> <code>.Rbuildignore</code>
</h3>
<p>你不需要经常考虑 <code>.tar.gz</code> 形式的软件包的确切结构，但你确实需要了解 <code>.Rbuildignore</code> 文件。 它决定了源码包中的哪些文件可以进入后面的工作流。</p>
<p><code>.Rbuildignore</code> 的每一行都是一个 Perl 兼容的正则表达式 (Perl-compatible regular expression, PCRE)，它会在不考虑大小写的情况下与源码包中每个文件的路径进行匹配<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>。 如果正则表达式匹配到了文件或目录，那么该文件或目录将会被排除，无法进入之后的软件包开发工作流。 注意，有一些默认排除项由 R 本身执行，主要与经典的版本控制系统和编辑器（例如 SVN, Git 和 Emacs）有关。</p>
<p>我们通常使用 <code><a href="https://usethis.r-lib.org/reference/use_build_ignore.html">usethis::use_build_ignore()</a></code> 函数来修改 <code>.Rbuildignore</code>，该函数能够帮助你处理一些容易遗忘的细节，例如正则表达式的添加定位锚点 (anchoring) 和转义 (escaping)。 要排除特定的文件或目录（这是最常见的用例），<strong>必须</strong>为正则表达式添加定位锚点 (anchor)。 例如，如果要排除一个名为 “notes” 的目录，<code>.Rbuildignore</code> 中对应条目必须是 <code>^notes$</code>，而没有添加定位锚点的正则表达式 <code>notes</code> 将会匹配任意包含 “notes” 的文件名，例如 <code>R/notes.R</code>, <code>man/important-notes.R</code>, <code>data/endnotes.Rdata</code> 等。 我们发现 <code><a href="https://usethis.r-lib.org/reference/use_build_ignore.html">use_build_ignore()</a></code> 有助于我们第一次就更准确地获取更多的 <code>.Rbuildignore</code> 条目。</p>
<p><code>.Rbuildignore</code> 提供了一种解决方式，能够协调支持开发流程的常规做法和 CRAN 对软件包提交和分发的要求之间的一些紧张关系 (<span class="quarto-unresolved-ref">?sec-release</span>)。 即使你不打算在 CRAN 上发布你的软件包，遵循这些约定也能让你充分地利用 R 的内置工具来检查和安装程序包。 你应该添加到 <code>.Rbuildignore</code> 中的文件分为两个半重叠的类别：</p>
<ul>
<li>帮助你以编程方式生成软件包内容的文件。例如：
<ul>
<li>使用 <code>README.Rmd</code> 生成信息丰富且最新的 <code>README.md</code> (<span class="quarto-unresolved-ref">?sec-readme</span>)。</li>
<li>储存用于创建和更新内部或导出数据的 <code>.R</code> 脚本 (<span class="quarto-unresolved-ref">?sec-data-data-raw</span>)。</li>
</ul>
</li>
<li>在 CRAN 的要求之外驱动软件包开发、检查和文档的文件。例如：
<ul>
<li>和 RStudio IDE 有关的文件 (<a href="workflow101.html#sec-workflow101-rstudio-projects" class="quarto-xref"><span>Section 4.2</span></a>)。</li>
<li>使用 <a href="https://pkgdown.r-lib.org">pkgdown package</a> 生成的软件包网站 (<span class="quarto-unresolved-ref">?sec-website</span>)。</li>
<li>与持续集成/部署有关的配置文件 (<span class="quarto-unresolved-ref">?sec-sw-dev-practices-ci</span>)。</li>
</ul>
</li>
</ul>
<p>以下是一个 <code>.Rbuildignore</code> 文件非详尽的典型条目列表，来自 tidyverse 包：</p>
<pre><code>^.*\.Rproj$         # 指定目录为 RStudio 项目的文件
^\.Rproj\.user$     # RStudio 使用的临时文件
^README\.Rmd$       # 用于生成 README.md 的 Rmd 文件
^LICENSE\.md$       # 许可证全文
^cran-comments\.md$ # CRAN 提交的评论意见
^data-raw$          # 用于创建软件包中包含的数据的代码
^pkgdown$           # 用于软件包网站的资源文件
^_pkgdown\.yml$     # 软件包网站的配置文件
^\.github$          # GitHub Actions 工作流</code></pre>
<p>注意，上面的注释不能出现在实际的 <code>.Rbuildignore</code> 文件中，它们在这里只是为了说明文件作用。</p>
<p>当你需要向 <code>.Rbuildignore</code> 中添加文件时，我们会在书中提到。 请记住 <code><a href="https://usethis.r-lib.org/reference/use_build_ignore.html">usethis::use_build_ignore()</a></code> 是管理这类文件的一种有吸引力的方法。 此外，许多 usethis 函数在添加一个应该列在 <code>.Rbuildignore</code> 中的文件时会自动处理这个问题。 例如 <code>use_read_rmd()</code> 会将 “^README\.Rmd$” 添加到 <code>.Rbuildignore</code>。</p>
</section></section><section id="sec-structure-binary" class="level2" data-number="3.4"><h2 data-number="3.4" class="anchored" data-anchor-id="sec-structure-binary">
<span class="header-section-number">3.4</span> 二进制包 (Binary Package)</h2>
<p>If you want to distribute your package to an R user who doesn’t have package development tools, you’ll need to provide a <strong>binary</strong> package. The primary maker and distributor of binary packages is CRAN, not individual maintainers. But even if you delegate the responsibility of distributing your package to CRAN, it’s still important for a maintainer to understand the nature of a binary package.</p>
<p>Like a package bundle, a binary package is a single file. Unlike a bundled package, a binary package is platform specific and there are two basic flavors: Windows and macOS. (Linux users are generally required to have the tools necessary to install from <code>.tar.gz</code> files, although the emergence of resources like <a href="https://packagemanager.posit.co/">Posit Public Package Manager</a> is giving Linux users the same access to binary packages as their colleagues on Windows and macOS.)</p>
<p>Binary packages for macOS are stored as <code>.tgz</code>, whereas Windows binary packages end in <code>.zip</code>. If you need to make a binary package, use <code>devtools::build(binary = TRUE)</code> on the relevant operating system. Under the hood, this calls <code>pkgbuild::build(binary = TRUE)</code> and, ultimately, <code>R CMD INSTALL --build</code>, which is described further in the <a href="https://cran.r-project.org/doc/manuals/R-exts.html#Building-binary-packages">Building binary packages</a> section of <a href="https://cran.r-project.org/doc/manuals/R-exts.html">Writing R Extensions</a>. If you choose to release your package on CRAN (<span class="quarto-unresolved-ref">?sec-release</span>), you submit your package in bundled form, then CRAN creates and distributes the package binaries.</p>
<p>CRAN packages are usually available in binary form, for both macOS and Windows, for the current, previous, and (possibly) development versions of R. Continuing our examples from above, you could download binary packages such as:</p>
<ul>
<li>forcats for macOS: <code>forcats_0.4.0.tgz</code>
</li>
<li>readxl for Windows: <code>readxl_1.3.1.zip</code>
</li>
</ul>
<p>and this is, indeed, part of what’s usually going on behind the scenes when you call <code><a href="https://rdrr.io/r/utils/install.packages.html">install.packages()</a></code>.</p>
<p>If you uncompress a binary package, you’ll see that the internal structure is rather different from a source or bundled package. <a href="#fig-package-files" class="quarto-xref">Figure&nbsp;<span>3.1</span></a> includes this comparison, so this is a good time to revisit that diagram. Here are some of the most notable differences:</p>
<ul>
<li><p>There are no <code>.R</code> files in the <code>R/</code> directory - instead there are three files that store the parsed functions in an efficient file format. This is basically the result of loading all the R code and then saving the functions with <code><a href="https://rdrr.io/r/base/save.html">save()</a></code>. (In the process, this adds a little extra metadata to make things as fast as possible).</p></li>
<li><p>A <code>Meta/</code> directory contains a number of <code>.rds</code> files. These files contain cached metadata about the package, like what topics the help files cover and a parsed version of the <code>DESCRIPTION</code> file. (You can use <code><a href="https://rdrr.io/r/base/readRDS.html">readRDS()</a></code> to see exactly what’s in those files). These files make package loading faster by caching costly computations.</p></li>
<li><p>The actual help content appears in <code>help/</code> and <code>html/</code> (no longer in <code>man/</code>).</p></li>
<li><p>If you had any code in the <code>src/</code> directory, there will now be a <code>libs/</code> directory that contains the results of compiling the code.</p></li>
<li><p>If you had any objects in <code>data/</code>, they have now been converted into a more efficient form.</p></li>
<li><p>The contents of <code>inst/</code> are moved to the top-level directory. For example, vignette files are now in <code>doc/</code>.</p></li>
<li><p>Some files and folders have been dropped, such as <code>README.md</code>, <code>build/</code>, <code>tests/</code>, and <code>vignettes/</code>.</p></li>
</ul></section><section id="sec-installed-package" class="level2" data-number="3.5"><h2 data-number="3.5" class="anchored" data-anchor-id="sec-installed-package">
<span class="header-section-number">3.5</span> 已安装的包 (Installed package)</h2>
<p>An <strong>installed</strong> package is a binary package that’s been decompressed into a package library (described in <a href="#sec-library" class="quarto-xref"><span>Section 3.7</span></a>). <a href="#fig-installation" class="quarto-xref">Figure&nbsp;<span>3.2</span></a> illustrates the many ways a package can be installed, along with a few other functions for converting a package from one state to another. This diagram is complicated! In an ideal world, installing a package would involve stringing together a set of simple steps: source -&gt; bundle, bundle -&gt; binary, binary -&gt; installed. In the real world, it’s not this simple because there are often (faster) shortcuts available.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-installation" class="quarto-figure quarto-figure-center quarto-float anchored" alt="A chart showing different ways to go from one package state to another: 1. library() puts an installed package into memory. 2. Functions such as install.packages(),    devtools::install_github(), and devtools::install()    can install a package starting variously in the source,    bundle, or binary forms. 3. devtools::build() can create a bundle or a binary. 4. devtools::load_all() puts a source package into memory.">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-installation-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="diagrams/install-load.png" class="img-fluid figure-img" alt="A chart showing different ways to go from one package state to another: 1. library() puts an installed package into memory. 2. Functions such as install.packages(),    devtools::install_github(), and devtools::install()    can install a package starting variously in the source,    bundle, or binary forms. 3. devtools::build() can create a bundle or a binary. 4. devtools::load_all() puts a source package into memory." width="933">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-installation-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.2: Many methods for converting between package states.
</figcaption></figure>
</div>
</div>
</div>
<p>The built-in command line tool <code>R CMD INSTALL</code> powers all package installation. It can install a package from source files, a bundle (a.k.a. a source tarball), or a binary package. Details are available in the <a href="https://cran.r-project.org/doc/manuals/R-admin.html#Installing-packages">Installing packages section</a> of <a href="https://cran.r-project.org/doc/manuals/R-admin.html">R Installation and Administration</a>. Just like with <code><a href="https://devtools.r-lib.org/reference/build.html">devtools::build()</a></code>, devtools provides a wrapper function, <code><a href="https://devtools.r-lib.org/reference/install.html">devtools::install()</a></code>, that makes this tool available from within an R session.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
RStudio
</div>
</div>
<div class="callout-body-container callout-body">
<p>RStudio can also help you install your in-development package via the <em>Install</em> and <em>More</em> drop-downs in the <em>Build</em> pane and with <em>Install Package</em> in the <em>Build</em> menu.</p>
</div>
</div>
<p>Most useRs understandably like to install packages from the comfort of an R session and directly from CRAN. The built-in function <code><a href="https://rdrr.io/r/utils/install.packages.html">install.packages()</a></code> meets this need. It can download the package, in various forms, install it, and optionally attend to the installation of dependencies.</p>
<p>There is a price, however, for the convenience of installing R packages from within an R session. As you might expect, it can be a bit tricky to re-install a package that is already in use in the current session. This actually works most of the time, but sometimes it does not, especially when installing an R package with compiled code on Windows. Due to how file handles are locked on Windows, an attempt to install a new version of a package that’s in use can result in a corrupt installation where the package’s R code has been updated, but its compiled code has not. When troubleshooting, Windows users should strive to install packages in a clean R session, with as few packages loaded as possible.</p>
<p>The pak package (<a href="https://pak.r-lib.org/" class="uri">https://pak.r-lib.org/</a>) is a relative newcomer (at the time of writing) and provides a promising alternative to <code><a href="https://rdrr.io/r/utils/install.packages.html">install.packages()</a></code>, as well as other more specialized functions such as <code><a href="https://remotes.r-lib.org/reference/install_github.html">devtools::install_github()</a></code>. It’s too early to make a blanket recommendation for using pak for all of your package installation needs, but we are certainly using it more and more in our personal workflows. One of pak’s flagship features is that it nicely solves the “locked DLL” problem described above, i.e.&nbsp;updating a package with compiled code on Windows. As you get deeper into package development, you will find yourself doing a whole new set of tasks, such as installing a dependency from an in-development branch or scrutinizing package dependency trees. pak provides a rich toolkit for this and many other related tasks. We predict that pak will soon become our official recommendation for how to install packages (and more).</p>
<p>However, in the meantime, we describe the <em>status quo</em>. devtools has long offered a family of <code>install_*()</code> functions to address some needs beyond the reach of <code><a href="https://rdrr.io/r/utils/install.packages.html">install.packages()</a></code> or to make existing capabilities easier to access. These functions are actually maintained in the <a href="https://remotes.r-lib.org">remotes package</a> and are re-exported by devtools. (Given what we said above, it is likely that remotes will essentially become superseded, in favor of pak, but we’re not quite there yet.)</p>
<div class="cell">
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://remotes.r-lib.org">remotes</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">funs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/ls_str.html">lsf.str</a></span><span class="op">(</span><span class="st">"package:remotes"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/grep.html">grep</a></span><span class="op">(</span><span class="st">"^install_.+"</span>, <span class="va">funs</span>, value <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] "install_bioc"      "install_bitbucket" "install_cran"     </span></span>
<span><span class="co">#&gt;  [4] "install_deps"      "install_dev"       "install_git"      </span></span>
<span><span class="co">#&gt;  [7] "install_github"    "install_gitlab"    "install_local"    </span></span>
<span><span class="co">#&gt; [10] "install_remote"    "install_svn"       "install_url"      </span></span>
<span><span class="co">#&gt; [13] "install_version"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><code><a href="https://remotes.r-lib.org/reference/install_github.html">install_github()</a></code> is the most useful of these functions and is also featured in <a href="#fig-installation" class="quarto-xref">Figure&nbsp;<span>3.2</span></a>. It is the flagship example of a family of functions that can download a package from a remote location that is not CRAN and do whatever is necessary to install it and its dependencies. The rest of the devtools/remotes <code>install_*()</code> functions are aimed at making things that are technically possible with base tooling a bit easier or more explicit, such as <code><a href="https://remotes.r-lib.org/reference/install_version.html">install_version()</a></code> which installs a specific version of a CRAN package.</p>
<p>Analogous to <code>.Rbuildignore</code>, described in section <a href="#sec-rbuildignore" class="quarto-xref"><span>Section 3.3.1</span></a>, <code>.Rinstignore</code> lets you keep files present in a package bundle out of the installed package. However, in contrast to <code>.Rbuildignore</code>, this is rather obscure and rarely needed.</p>
</section><section id="内存中的包-in-memory-package" class="level2" data-number="3.6"><h2 data-number="3.6" class="anchored" data-anchor-id="内存中的包-in-memory-package">
<span class="header-section-number">3.6</span> 内存中的包 (In-memory package)</h2>
<p>我们终于讲到了一个每个使用 R 的人都熟悉的命令：</p>
<div class="cell">
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://usethis.r-lib.org">usethis</a></span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>假设你已经安装了 usethis，这个函数调用会使得 usethis 包的所有函数都能够使用，也就是说，我们现在可以直接执行函数：</p>
<div class="cell">
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://usethis.r-lib.org/reference/create_package.html">create_package</a></span><span class="op">(</span><span class="st">"/path/to/my/coolpackage"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>usethis 包现在已经被载入了内存，实际上，它也被附加到了搜索路径中。 在编写脚本时，载入和附加软件包之间的区别并不重要，但是当你编写软件包时却非常重要。 你将在 <span class="quarto-unresolved-ref">?sec-dependencies-attach-vs-load</span> 中了解到它们之间的区别和重要性。</p>
<p><code><a href="https://rdrr.io/r/base/library.html">library()</a></code> 并不是迭代地调整和测试驱动一个软件包的好方法，因为它只对已安装的包起作用。 在 <a href="workflow101.html#sec-workflow101-load-all" class="quarto-xref"><span>Section 4.4</span></a> 中你将会了解到 <code><a href="https://devtools.r-lib.org/reference/load_all.html">devtools::load_all()</a></code> 是如何通过允许你直接将源码包加载到内存中来加速开发的。</p>
</section><section id="sec-library" class="level2" data-number="3.7"><h2 data-number="3.7" class="anchored" data-anchor-id="sec-library">
<span class="header-section-number">3.7</span> 软件包库 (Package libraries)</h2>
<p>We just discussed the <code><a href="https://rdrr.io/r/base/library.html">library()</a></code> function, whose name is inspired by what it does. When you call <code><a href="https://rdrr.io/r/base/library.html">library(somepackage)</a></code>, R looks through the current <strong>libraries</strong> for an installed package named “somepackage” and, if successful, it makes somepackage available for use.</p>
<p>In R, a <strong>library</strong> is a directory containing installed packages, sort of like a library for books. Unfortunately, in the R world, you will frequently encounter confused usage of the words “library” and “package”. It’s common for someone to refer to dplyr, for example, as a library when it is actually a package. There are a few reasons for the confusion. First, R’s terminology arguably runs counter to broader programming conventions, where the usual meaning of “library” is closer to what we mean by “package”. The name of the <code><a href="https://rdrr.io/r/base/library.html">library()</a></code> function itself probably reinforces the wrong associations. Finally, this vocabulary error is often harmless, so it’s easy for R users to fall into the wrong habit and for people who point out this mistake to look like insufferable pedants. But here’s the bottom line:</p>
<blockquote class="blockquote">
<p>We use the <code><a href="https://rdrr.io/r/base/library.html">library()</a></code> function to load <a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a> a <strong>package</strong>.</p>
</blockquote>
<p>The distinction between the two is important and useful as you get involved in package development.</p>
<p>You can have multiple libraries on your computer. In fact, many of you already do, especially if you’re on Windows. You can use <code><a href="https://rdrr.io/r/base/libPaths.html">.libPaths()</a></code> to see which libraries are currently active. Here’s how this might look on Windows:</p>
<div class="cell">
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># on Windows</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/libPaths.html">.libPaths</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "C:/Users/jenny/Documents/R/win-library/4.2"</span></span>
<span><span class="co">#&gt; [2] "C:/Program Files/R/R-4.2.2/library"</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/libPaths.html">.libPaths</a></span><span class="op">(</span><span class="op">)</span>, <span class="va">list.dirs</span>, recursive <span class="op">=</span> <span class="cn">FALSE</span>, full.names <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#&gt; [[1]]</span></span>
<span><span class="co">#&gt;   [1] "abc"           "anytime"       "askpass"       "assertthat"   </span></span>
<span><span class="co">#&gt;  ...</span></span>
<span><span class="co">#&gt; [145] "zeallot"      </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[2]]</span></span>
<span><span class="co">#&gt;  [1] "base"         "boot"         "class"        "cluster"     </span></span>
<span><span class="co">#&gt;  [5] "codetools"    "compiler"     "datasets"     "foreign"     </span></span>
<span><span class="co">#&gt;  [9] "graphics"     "grDevices"    "grid"         "KernSmooth"  </span></span>
<span><span class="co">#&gt; [13] "lattice"      "MASS"         "Matrix"       "methods"     </span></span>
<span><span class="co">#&gt; [17] "mgcv"         "nlme"         "nnet"         "parallel"    </span></span>
<span><span class="co">#&gt; [21] "rpart"        "spatial"      "splines"      "stats"       </span></span>
<span><span class="co">#&gt; [25] "stats4"       "survival"     "tcltk"        "tools"       </span></span>
<span><span class="co">#&gt; [29] "translations" "utils"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here’s a similar look on macOS (but your results may vary):</p>
<div class="cell">
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># on macOS</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/libPaths.html">.libPaths</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "/Users/jenny/Library/R/arm64/4.2/library"</span></span>
<span><span class="co">#&gt; [2] "/Library/Frameworks/R.framework/Versions/4.2-arm64/Resources/library"</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/libPaths.html">.libPaths</a></span><span class="op">(</span><span class="op">)</span>, <span class="va">list.dirs</span>, recursive <span class="op">=</span> <span class="cn">FALSE</span>, full.names <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#&gt; [[1]]</span></span>
<span><span class="co">#&gt;    [1] "abc"                  "abc.data"             "abind"                </span></span>
<span><span class="co">#&gt;  ...</span></span>
<span><span class="co">#&gt; [1033] "Zelig"                "zip"                  "zoo"                 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[2]]</span></span>
<span><span class="co">#&gt;  [1] "base"         "boot"         "class"        "cluster"     </span></span>
<span><span class="co">#&gt;  [5] "codetools"    "compiler"     "datasets"     "foreign"     </span></span>
<span><span class="co">#&gt;  [9] "graphics"     "grDevices"    "grid"         "KernSmooth"  </span></span>
<span><span class="co">#&gt; [13] "lattice"      "MASS"         "Matrix"       "methods"     </span></span>
<span><span class="co">#&gt; [17] "mgcv"         "nlme"         "nnet"         "parallel"    </span></span>
<span><span class="co">#&gt; [21] "rpart"        "spatial"      "splines"      "stats"       </span></span>
<span><span class="co">#&gt; [25] "stats4"       "survival"     "tcltk"        "tools"       </span></span>
<span><span class="co">#&gt; [29] "translations" "utils"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In both cases we see two active libraries, consulted in this order:</p>
<ol type="1">
<li>A user library</li>
<li>A system-level or global library</li>
</ol>
<p>This setup is typical on Windows, but is something you usually need to opt into on macOS and Linux<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a>. With this setup, add-on packages installed from CRAN (or elsewhere) or under local development are kept in the user library. Above, the macOS system is used as a primary development machine and has many packages here (~1000), whereas the Windows system is only used occasionally and is much more spartan. The core set of base and recommended packages that ship with R live in the system-level library and are the same on all operating systems. This separation appeals to many developers and makes it easy to, for example, clean out your add-on packages without disturbing your base R installation.</p>
<p>If you’re on macOS or Linux and only see one library, there is no urgent need to change anything. But next time you upgrade R, consider creating a user-level library. By default, R looks for a user library found at the path stored in the environment variable <code>R_LIBS_USER</code>, which itself defaults to <code>~/Library/R/m/x.y/library,</code> on macOS, and <code>~/R/m-library/x.y</code> on Linux (where <code>m</code> is a concise description of your CPU architecture, and <code>x.y</code> is the R version). You can see this path with <code>Sys.getenv("R_LIBS_USER")</code>. These directories do not exist by default, and the use of them must be enabled by creating the directory. When you install a new version of R, and prior to installing any add-on packages, use <code>dir.create(Sys.getenv("R_LIBS_USER"), recursive = TRUE)</code> to create a user library in the default location. Now you will have the library setup seen above. Alternatively, you could set up a user library elsewhere and tell R about that by setting the <code>R_LIBS_USER</code> environment variable in <code>.Renviron</code>. The simplest way to edit your <code>.Renviron</code> file is with <code><a href="https://usethis.r-lib.org/reference/edit.html">usethis::edit_r_environ()</a></code>, which will create the file if it doesn’t exist, and open it for editing.</p>
<p>The filepaths for these libraries also make it clear they are associated with a specific version of R (4.2.x at the time of writing), which is also typical. This reflects and enforces the fact that you need to reinstall your add-on packages when you update R from, say, 4.1 to 4.2, which is a change in the <strong>minor</strong> version. You generally do not need to re-install add-on packages for a <strong>patch</strong> release, e.g., going from R 4.2.1 to 4.2.2.</p>
<p>As your R usage grows more sophisticated, it’s common to start managing package libraries with more intention. For example, tools like <a href="https://rstudio.github.io/renv/">renv</a> (and its predecessor <a href="https://rstudio.github.io/packrat/">packrat</a>) automate the process of managing project-specific libraries. This can be important for making data products reproducible, portable, and isolated from one another. A package developer might prepend the library search path with a temporary library, containing a set of packages at specific versions, in order to explore issues with backwards and forwards compatibility, without affecting other day-to-day work. Reverse dependency checks are another example where we explicitly manage the library search path.</p>
<p>Here are the main levers that control which libraries are active, in order of scope and persistence:</p>
<ul>
<li>Environment variables, like <code>R_LIBS</code> and <code>R_LIBS_USER</code>, which are consulted at startup.</li>
<li>Calling <code><a href="https://rdrr.io/r/base/libPaths.html">.libPaths()</a></code> with one or more filepaths.</li>
<li>Executing small snippets of code with a temporarily altered library search path via <code><a href="https://withr.r-lib.org/reference/with_libpaths.html">withr::with_libpaths()</a></code>.</li>
<li>Arguments to individual functions, like <code>install.packages(lib =)</code> and <code><a href="https://rdrr.io/r/base/library.html">library(lib.loc =)</a></code>.</li>
</ul>
<p>Finally, it’s important to note that <code><a href="https://rdrr.io/r/base/library.html">library()</a></code> should NEVER be used <em>inside a package</em>. Packages and scripts rely on different mechanisms for declaring their dependencies and this is one of the biggest adjustments you need to make in your mental model and habits. We explore this topic fully in <span class="quarto-unresolved-ref">?sec-description-imports-suggests</span> and <span class="quarto-unresolved-ref">?sec-dependencies-in-practice</span>.</p>


</section><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><hr>
<ol>
<li id="fn1"><p>译者注：“归档”一词在中国大陆的用语习惯中较少使用，但考虑 <code>tar</code> 的原意，确实有“为一个版本创建只读快照”的含义，和这里的 R 包相符。<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>要查看会参与匹配的所有文件路径的集合，请在软件包的顶层目录执行命令 <code>dir(full.names = TRUE, recursive = TRUE, include.dirs = TRUE, all.files = TRUE)</code>。<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>Well, actually, <code><a href="https://rdrr.io/r/base/library.html">library()</a></code> loads and attaches a package, but that’s a topic for <span class="quarto-unresolved-ref">?sec-dependencies-attach-vs-load</span>.<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4"><p>For more details, see the <a href="https://rstats.wtf/maintaining-r#how-to-transfer-your-library-when-updating-r">Maintaining R section</a> in <em>What They Forgot To Teach You About R</em>, <a href="https://rstudio.github.io/r-manuals/r-admin/Add-on-packages.html#managing-libraries">Managing Libraries</a> in <em>R Installation and Administration</em> and the R help files for <code><a href="https://rdrr.io/r/base/Startup.html">?Startup</a></code> and <code><a href="https://rdrr.io/r/base/libPaths.html">?.libPaths</a></code>.<a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol></section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./setup.html" class="pagination-link  aria-label=">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">系统设置</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./workflow101.html" class="pagination-link" aria-label="<span class='chapter-number'>4</span>&nbsp; <span class='chapter-title'>基本开发工作流</span>">
        <span class="nav-page-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">基本开发工作流</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/YuanchenZhu2020/R-Packages-zh/edit/main/structure.Rmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/YuanchenZhu2020/R-Packages-zh/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div></div></footer></body></html>