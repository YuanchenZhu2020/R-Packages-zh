[[sec-preface]]
= 前言
:description: 学习如何创建软件包（package），它是可分享、可复用和可重复的 R 代码。

欢迎阅读 _R packages_ 第二版！ 如果你熟悉第一版的内容，这篇序言介绍了第二版中主要的内容变化，这样你就可以把阅读重点放在新的部分。

这一版有一些主要的变化：

* 更新了反映 devtools 软件包变化的内容，特别是关于它被 https://www.tidyverse.org/articles/2018/10/devtools-2-0-0/#conscious-uncoupling["`有意识地解耦 (conscious uncoupling)`"] 为一系列更小，但功能更集中的软件包。
* 在介绍构成 R 包的所有重要可变组件的同时，扩大了对工作流 (workflow) 和流程 (process) 的内容覆盖范围。
* 涵盖全新的主题，如构建软件包网站和 GitHub Actions。

所有的内容已经被完全修改和更新。 许多章节都是新加入的，或是被重新组织，也有一些章节被移除了：

* 新的章节 <<sec-whole-game>> "`整体流程`"。本章概述了整个软件包的开发过程。
* 新的章节 <<sec-setup>> "`系统设置`"。本章已经从之前版本的“简介 (Introduction)”一章分离出来，并增加了更多细节内容。
* 原先名为“软件包结构 (Package structure)”的章节已经扩展了内容并分为两章，一章涵盖了软件包结构和状态 (<<sec-package-structure-state>>) ，另一章涉及工作流和工具 (<<sec-workflow101>>)。
* 新的章节 <<sec-package-within>> "`软件包中的奥秘`"。本章演示了如何从数据分析脚本中提取可复用的逻辑并将其放入包中。
* <<sec-r>> "`R 代码`"中“组织你的函数 (Organising your functions)”和“代码风格 (Code style)”部分已被删除，转而采用一篇在线的代码风格指南 https://style.tidyverse.org/。 这篇代码风格指南与新的 styler 软件包<<styler>> 搭配使用，可以自动应用许多编码规则。
* 有关软件包测试的内容以及扩展成三个章节： <<sec-testing-basics>> 是软件包测试基础， <<sec-testing-design>> 是测试套件的设计，而 <<sec-testing-advanced>> 则包含了各种高级的内容主题。
* 围绕 `+NAMESPACE+` 文件和依赖关系的内容被重新组织成两章：<<sec-dependencies-mindset-background>> 提供了让我们深入思考如何处理软件包依赖关系的技术知识，<<sec-dependencies-in-practice>> 给出了在不同情况下使用不同类型依赖关系的操作细节。
* 新的章节 <<sec-license>> "`添加开源许可证`"。本章将之前关于添加开源许可证的内容扩展为单独的一章。
* 删除了关于 C/C++ 的章节。 因为它没有提供足够有用的信息，并且自本书第一版以来，出现了其他更好的学习资源。
* 删除了“其他组件 (Other components)”一章。
* 关于 Git/GitHub 的章节以及围绕软件开发实践 (<<sec-sw-dev-practices>>) 这一更普遍的主题进行了重构。 这章将不一步步说明使用 Git/GitHub 的基本步骤。 自本书第一版依赖，Git/GitHub 的使用呈现爆炸式增长，同时和 R 相关的通用和特定主题学习资源也同样飞速增长（例如 https://happygitwithr.com/index.html[Happy Git and GitHub for the useR] 网站）。 Git/GitHub 在本书中仍然占据重要地位，特别是在 <<sec-sw-dev-practices>>。
* 非常简短的 "`inst`" 一章已经被合并到 <<sec-misc>> 中，内容包括对所有其它的目录的介绍，这些目录在特定情况下可能很重要，但对所有软件包来说并不是必要的。

== 致谢

自从 R Packages 第一版发布以来，支持本书描述的工作流的软件包已经有了广泛的发展。 最初的三个软件包 devtools, roxygen2 和 testthat 已经扩展到由 devtools "`有意识地解耦`"所创建的许多软件包，就如 <<sec-setup-usage>> 所描述的那样。 由于它们具有共同的根源 devtools，因此这些软件包多数源自 Hadley Wickham (HW)。 还有许多其他重要的贡献者，其中许多人现在是软件包的维护者：

* devtools: HW, https://github.com/wch[Winston Chang], https://github.com/jimhester[Jim Hester] (maintainer, >= v1.13.5), https://github.com/jennybc[Jennifer Bryan] (maintainer >= v2.4.3)
* usethis: HW, https://github.com/jennybc[Jennifer Bryan] (maintainer >= v1.5.0), Malcolm Barrett
* roxygen2: HW (maintainer), https://github.com/klutometis[Peter Danenburg], https://github.com/mjaeugster[Manuel Eugster]
* testthat: HW (maintainer)
* desc: https://github.com/gaborcsardi[Gábor Csárdi] (maintainer), https://github.com/krlmlr[Kirill Müller], https://github.com/jimhester[Jim Hester]
* pkgbuild: HW, https://github.com/jimhester[Jim Hester], https://github.com/gaborcsardi[Gábor Csárdi] (maintainer >= v1.2.1)
* pkgload: HW, https://github.com/jimhester[Jim Hester], https://github.com/wch[Winston Chang], https://github.com/lionel-[Lionel Henry] (maintainer >= v1.2.4)
* rcmdcheck: https://github.com/gaborcsardi[Gábor Csárdi] (maintainer)
* remotes: HW, https://github.com/jimhester[Jim Hester], https://github.com/gaborcsardi[Gábor Csárdi] (maintainer), https://github.com/wch[Winston Chang], https://github.com/mtmorgan[Martin Morgan], https://github.com/dtenenba[Dan Tenenbaum]
* revdepcheck: HW, https://github.com/gaborcsardi[Gábor Csárdi] (maintainer)
* sessioninfo: HW, https://github.com/gaborcsardi[Gábor Csárdi] (maintainer), https://github.com/wch[Winston Chang], https://github.com/rmflight[Robert Flight], https://github.com/krlmlr[Kirill Müller], https://github.com/jimhester[Jim Hester]

这本书是https://github.com/hadley/r-pkgs/[公开编写和修订的]，它是社区努力的成果：许多人阅读草稿、修正错别字 、提出改进意见以及贡献内容。 没有这些贡献者，这本书不会像现在这样好，我们对他们的帮助深表感谢。 我们要感谢我们在 Posit 的同事，特别是 tidyverse 团队，他们一直很乐意讨论软件包的开发实践。 另外，我们出色的技术审查员团队提出的建议也极大地改进了本书：Malcolm Barrett, Laura DeCicco, Zhian Kamvar, Tom Mock and Maëlle Salmon。

Thanks go to all contributors who submitted improvements via github (in alphabetical order): `+@aaronwolen+`, `+@ablejec+`, Adam Yormark, `+@adessy+`, Adrien Todeschini, Alan Haynes, Alexander Grüneberg, Alison Presmanes Hill, Andrea Cantieni, Andrew Bray, Andrew Craig, Andy Teucher, Andy Visser, `+@apomatix+`, Arni Magnusson, Ben Bond-Lamberty, Ben Marwick, Berry Boessenkool, `+@bm5tev3+`, Brandon Greenwell, Brett Johnson, Brett K, Brett Klamer, Brian Rice, Brooke Anderson, `+@btruel+`, `+@CAPN+`, Carl A. B. Pearson, Chao Cheng, Chester Ismay, Choyoung Yim, `+@chsafouane+`, `+@contravariant+`, Craig Citro, Crt Ahlin, Dan Yavorsky, `+@danhalligan+`, Daniel Falbel, Daniel Lee, David Robinson, David Smith, `+@davidkane9+`, Dean Attali, `+@deanbodenhambsse+`, Douglas K. G. Araujo, `+@dracodoc+`, `+@dryzliang+`, Earl Brown, Eduardo Ariño de la Rubia, `+@eipi10+`, Enrico Spinielli, `+@eogoodwin+`, Erik Erhardt, Ewan Dunbar, Federico Marini, Florian Kohrt, Floris Vanderhaeghe, Gerhard Nachtmann, Gerrit-Jan Schutten, Greg Macfarlane, Gustav W Delius, Hadley Wickham, Hannah Frick, `+@harrismcgehee+`, Hedderik van Rijn, `+@helix123+`, `+@henningte+`, Henrik Bengtsson, `+@heogden+`, Howard Baek, Hugo Gruson, Ian Gow, `+@iargent+`, Iaroslav Domin, Ibrahim Kekec, Ionut Stefan-Birdea, `+@jacobbien+`, James Keirstead, James Laird-Smith, Jee Roen, Jennifer (Jenny) Bryan, Jenny Bryan, `+@Jeremiah+`, Jim Hester, `+@jmarshallnz+`, Jo-Anne Tan, Joanna Zhao, Joe Cainey, Joe Thorley, Johan Larsson, John Baumgartner, John Blischak, `+@jomuller+`, Jon Harmon, `+@Jordan+`, `+@jowalski+`, Justin Alford, Karl Broman, Karthik Ram, `+@Kasper+`, `+@KatherineCox+`, Katrin Leinweber, Kevin Ushey, Kevin Wright, Kirill Müller, Kristopher Kapphahn, Kun Ren, `+@kwenzig+`, `+@kylelundstedt+`, `+@lancelote+`, Lech Madeyski, `+@Leon+`, `+@lindbrook+`, Lluis Ramon, Maëlle Salmon, `+@maiermarco+`, Malcolm Barrett, Manuel Reif, Mara Averick, Mark Dulhunty, `+@martin-mfg+`, Matan Hakim, Matthew Roberts, Mauro Lepore, Michael Boerman, Michael Buckley, `+@michaelweylandt+`, Michel Lang, `+@miguelmorin+`, `+@MikeJohnPage+`, `+@MikeLeonard+`, `+@nareal+`, Nathan Levett, Nathaniel Phillips, `+@nattalides+`, `+@Nic+`, Nicholas Tierney, Nick Carchedi, Nick Zeng, `+@NS+`, Oliver Keyes, Øystein Sørensen, Pablo Rodríguez-Sánchez, Patrick Kimes, Paul Blischak, Peter Meissner, `+@PeterDee+`, Philip Crain, Philip Pallmann, Po Su, `+@PrzeChoj+`, R. Mark Sharp, `+@ramiromagno+`, Richard M. Smith, Rick Tankard, `+@rmar073+`, `+@rmsharp+`, Robert Krzyzanowski, Robin Gower, `+@robiRagan+`, Ryan Peterson, `+@ryanatanner+`, Salim B, Sam Firke, Sascha Holzhauer, `+@scharne+`, Scott Rohde, Sean Wilkinson, Sébastien Rochette, Sergey Grechin, `+@setoyama60jp+`, Shannon Pileggi, Shantanu Singh, Shaun Walbridge, Shinya Uryu, `+@SimonPBiggs+`, Stefan Eng, Stefan Herzog, Stefan Jansson, Stefan Widgren, Stephen Frank, Stephen Rushe, `+@stevensbr+`, Tanner Stauss, Telmo Brugnara, Tony Breyal, Tony Fischetti, `+@TroyVan+`, `+@urmils+`, Vince Knight, Vlad Petyuk, Wenjie Wang, Will Beasley, Winston Chang, `+@winterschlaefer+`, Wouter Saelens, `+@wrathematics+`, Xiaosong Zhang, Y. Yu, Yihui Xie, `+@ysdgroot+`, `+@yui-knk+`, Zeki Akyol, `+@zhaoy+`, Zhian N. Kamvar, Zhuoer Dong.

== Conventions

在本书中，我们用 `+fun()+` 来指代函数，用 `+var+` 来指代变量和函数参数，用 `+path/+` 来指代路径。

较大的代码块同时包含输入和输出。 代码输出的内容都被注释了，因此如果你有本书的电子版本，例如 https://r-pkgs.org，就可以轻松地将示例代码复制和粘贴到 R 中。 输出内容的注释看起来像 `+#>+`，这样可以和普通注释区别开来。

== Colophon

本书是在 https://www.rstudio.com/products/rstudio/[RStudio] 中使用 https://quarto.org[Quarto] 编写的。 本书 https://r-pkgs.org[官方网站] 由 https://www.netlify.com[Netlify] 托管，并使用 GitHub actions 在每次提交后自动更新。 完整的源代码可以在 https://github.com/hadley/r-pkgs[GitHub] 上找到

本书的当前版本是在如下环境下构建的：

[source,r,cell-code]
----
library(devtools)
#> Warning: package 'devtools' was built under R version 4.2.2
#> Loading required package: usethis
#> Warning: package 'usethis' was built under R version 4.2.2
library(roxygen2)
#> Warning: package 'roxygen2' was built under R version 4.2.3
library(testthat)
#> Warning: package 'testthat' was built under R version 4.2.2
#> 
#> Attaching package: 'testthat'
#> The following object is masked from 'package:devtools':
#> 
#>     test_file
devtools::session_info()
#> ─ Session info ───────────────────────────────────────────────────
#>  setting  value
#>  version  R version 4.2.1 (2022-06-23 ucrt)
#>  os       Windows 10 x64 (build 22000)
#>  system   x86_64, mingw32
#>  ui       RTerm
#>  language (EN)
#>  collate  Chinese (Simplified)_China.utf8
#>  ctype    Chinese (Simplified)_China.utf8
#>  tz       Asia/Taipei
#>  date     2023-05-07
#>  pandoc   3.1 @ D:/Program Files/Pandoc/ (via rmarkdown)
#> 
#> ─ Packages ───────────────────────────────────────────────────────
#>  package     * version date (UTC) lib source
#>  brio          1.1.3   2021-11-30 [1] CRAN (R 4.2.2)
#>  cachem        1.0.6   2021-08-19 [1] CRAN (R 4.2.1)
#>  callr         3.7.3   2022-11-02 [1] CRAN (R 4.2.3)
#>  cli           3.6.1   2023-03-23 [1] CRAN (R 4.2.3)
#>  crayon        1.5.1   2022-03-26 [1] CRAN (R 4.2.1)
#>  devtools    * 2.4.5   2022-10-11 [1] CRAN (R 4.2.2)
#>  digest        0.6.29  2021-12-01 [1] CRAN (R 4.2.1)
#>  ellipsis      0.3.2   2021-04-29 [1] CRAN (R 4.2.1)
#>  evaluate      0.21    2023-05-05 [1] CRAN (R 4.2.1)
#>  fastmap       1.1.0   2021-01-25 [1] CRAN (R 4.2.1)
#>  fs            1.6.2   2023-04-25 [1] CRAN (R 4.2.3)
#>  glue          1.6.2   2022-02-24 [1] CRAN (R 4.2.1)
#>  htmltools     0.5.5   2023-03-23 [1] CRAN (R 4.2.3)
#>  htmlwidgets   1.6.2   2023-03-17 [1] CRAN (R 4.2.3)
#>  httpuv        1.6.6   2022-09-08 [1] CRAN (R 4.2.1)
#>  jsonlite      1.8.4   2022-12-06 [1] CRAN (R 4.2.3)
#>  knitr         1.42    2023-01-25 [1] CRAN (R 4.2.3)
#>  later         1.3.0   2021-08-18 [1] CRAN (R 4.2.1)
#>  lifecycle     1.0.3   2022-10-07 [1] CRAN (R 4.2.2)
#>  magrittr      2.0.3   2022-03-30 [1] CRAN (R 4.2.1)
#>  memoise       2.0.1   2021-11-26 [1] CRAN (R 4.2.1)
#>  mime          0.12    2021-09-28 [1] CRAN (R 4.2.0)
#>  miniUI        0.1.1.1 2018-05-18 [1] CRAN (R 4.2.1)
#>  pkgbuild      1.4.0   2022-11-27 [1] CRAN (R 4.2.3)
#>  pkgload       1.3.2   2022-11-16 [1] CRAN (R 4.2.3)
#>  prettyunits   1.1.1   2020-01-24 [1] CRAN (R 4.2.1)
#>  processx      3.8.1   2023-04-18 [1] CRAN (R 4.2.3)
#>  profvis       0.3.7   2020-11-02 [1] CRAN (R 4.2.2)
#>  promises      1.2.0.1 2021-02-11 [1] CRAN (R 4.2.1)
#>  ps            1.7.1   2022-06-18 [1] CRAN (R 4.2.1)
#>  purrr         1.0.1   2023-01-10 [1] CRAN (R 4.2.3)
#>  R6            2.5.1   2021-08-19 [1] CRAN (R 4.2.1)
#>  Rcpp          1.0.9   2022-07-08 [1] CRAN (R 4.2.1)
#>  remotes       2.4.2   2021-11-30 [1] CRAN (R 4.2.1)
#>  rlang         1.1.1   2023-04-28 [1] CRAN (R 4.2.3)
#>  rmarkdown     2.21    2023-03-26 [1] CRAN (R 4.2.3)
#>  roxygen2    * 7.2.3   2022-12-08 [1] CRAN (R 4.2.3)
#>  rstudioapi    0.14    2022-08-22 [1] CRAN (R 4.2.3)
#>  sessioninfo   1.2.2   2021-12-06 [1] CRAN (R 4.2.2)
#>  shiny         1.7.2   2022-07-19 [1] CRAN (R 4.2.1)
#>  stringi       1.7.8   2022-07-11 [1] CRAN (R 4.2.1)
#>  stringr       1.5.0   2022-12-02 [1] CRAN (R 4.2.3)
#>  testthat    * 3.1.5   2022-10-08 [1] CRAN (R 4.2.2)
#>  tinytex       0.45    2023-04-18 [1] CRAN (R 4.2.3)
#>  urlchecker    1.0.1   2021-11-30 [1] CRAN (R 4.2.2)
#>  usethis     * 2.1.6   2022-05-25 [1] CRAN (R 4.2.2)
#>  vctrs         0.6.2   2023-04-19 [1] CRAN (R 4.2.3)
#>  xfun          0.39    2023-04-20 [1] CRAN (R 4.2.3)
#>  xml2          1.3.3   2021-11-30 [1] CRAN (R 4.2.1)
#>  xtable        1.8-4   2019-04-21 [1] CRAN (R 4.2.1)
#> 
#>  [1] D:/R/R-4.2.1/library
#> 
#> ──────────────────────────────────────────────────────────────────
----
